<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.messanger.mapper.ChattingMapper">

    <resultMap id="ChattingMap" type="com.project.messanger.dto.ChattingDto">
        <id property="chattingIdx" column="chatting_idx"/>
        <result property="name" column="name"/>
        <result property="creatorIdx" column="creator_idx"/>
        <result property="createdDate" column="created_date"/>
    </resultMap>

    <resultMap id="ChattingUserLinkMap" type="com.project.messanger.dto.ChattingUserLinkDto">
        <id property="linkIdx" column="link_idx"/>
        <result property="chattingIdx" column="chatting_idx"/>
        <result property="userIdx" column="user_idx"/>
    </resultMap>

    <resultMap id="ChattingMessageMap" type="com.project.messanger.dto.ChattingMessageDto">
        <id property="messageIdx" column="message_idx"/>
        <result property="chattingIdx" column="chatting_idx"/>
        <result property="fileIdx" column="file_idx"/>
        <result property="content" column="content"/>
        <result property="creatorIdx" column="creator_idx"/>
        <result property="createdDate" column="created_date"/>
    </resultMap>

    <select id="getChattingMessageList" parameterType="hashmap" resultMap="ChattingMessageMap">
        SELECT *
        FROM (
            SELECT *
            FROM chatting_message
            WHERE chatting_idx = #{chatting_idx}
            ORDER BY created_date DESC
            LIMIT ${limit} OFFSET ${offset}
        )
        ORDER BY created_date ASC
    </select>

    <select id="getChattingList" parameterType="hashmap" resultMap="ChattingMap">
        SELECT chatting.*
        FROM chatting
        LEFT JOIN
        (
            SELECT chatting_idx, MAX(created_date) AS chatting_date
            FROM chatting_message
            GROUP BY chatting_idx
        ) chatting_message
        ON chatting.chatting_idx = chatting_message.chatting_idx
        <where>
            <if test="name != null">
                AND (UPPER(name) LIKE CONCAT('%', UPPER(#{name}), '%')
            </if>
            <if test="user_idx != null">
                AND EXISTS (
                    SELECT 1
                    FROM chatting_user_link
                    WHERE chatting_idx = chatting.chatting_idx
                    AND user_idx = #{user_idx}
                )
            </if>
        </where>
        ORDER BY chatting_date DESC
    </select>

    <insert id="insertChattingMessage" parameterType="com.project.messanger.dto.ChattingMessageDto" useGeneratedKeys="true" keyProperty="messageIdx" keyColumn="message_idx">
        INSERT chatting_message
        SET chatting_idx = #{chattingIdx},
        <if test="fileIdx != null"> file_idx = #{fileIdx},</if>
        content = #{content},
        creator_idx = #{creatorIdx},
        created_date = NOW()
    </insert>

    <select id="getChattingByIdx" parameterType="hashmap" resultMap="ChattingUserLinkMap">
        SELECT *
        FROM chatting
        WHERE chatting_idx = #{chattingIdx}
          AND EXISTS (
            SELECT 1
            FROM chatting_user_link
            WHERE chatting_idx = chatting_idx
            AND user_idx = #{user_idx}
          )
    </select>

    <insert id="insertChatting" parameterType="com.project.messanger.dto.ChattingDto" useGeneratedKeys="true" keyProperty="chattingIdx" keyColumn="chatting_idx">
        INSERT chatting
        SET name = #{name},
            creator_idx = #{creatorIdx},
            created_date = NOW()
    </insert>

    <update id="updateChatting" parameterType="com.project.messanger.dto.ChattingDto">
        UPDATE chatting
        SET <choose>
                <when test="name != null"> name = #{name}</when>
                <otherwise> name = ''</otherwise>
            </choose>
        WHERE chatting_idx = #{chattingIdx}
    </update>

    <delete id="deleteChatting" parameterType="long">
        DELETE FROM chatting
        WHERE chatting_idx = #{chattingIdx}
    </delete>

    <insert id="insertChattingUserLink" parameterType="com.project.messanger.dto.ChattingUserLinkDto" useGeneratedKeys="true" keyProperty="linkIdx" keyColumn="link_idx">
        INSERT INTO chatting_user_link
        (
            chatting_idx,
            user_idx
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
        (
            #{item.chatting_idx},
            #{item.userIdx}
        )
        </foreach>
    </insert>

    <delete id="deleteChattingUserLink" parameterType="long">
        DELETE FROM chatting_user_link
        WHERE link_idx = #{linkIdx}
    </delete>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.messanger.mapper.ChecklistMapper">

    <resultMap id="ChecklistMap" type="com.project.messanger.dto.ChecklistDto">
        <id property="checklistIdx" column="checklist_idx"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="creatorIdx" column="creator_idx"/>
        <result property="createdDate" column="created_date"/>
        <result property="updatedDate" column="updated_date"/>
    </resultMap>

    <resultMap id="ChecklistItemMap" type="com.project.messanger.dto.ChecklistItemDto">
        <id property="itemIdx" column="item_idx"/>
        <result property="checklistIdx" column="checklist_idx"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
    </resultMap>

    <insert id="insertChecklist" parameterType="com.project.messanger.dto.ChecklistDto" useGeneratedKeys="true" keyProperty="checklistIdx" keyColumn="checklist_idx">
        INSERT checklist
        SET title = #{title},
        description = #{description},
        <choose>
            <when test="status != null"> status = #{status},</when>
            <otherwise> status = 'INCOMPLETE',</otherwise>
        </choose>
        creator_idx = #{creatorIdx},
        created_date = NOW(),
        updated_date = NOW()
    </insert>

    <update id="updateChecklist" parameterType="com.project.messanger.dto.ChecklistDto">
        UPDATE checklist
        SET <if test="title != null"> title = #{title},</if>
            <if test="description != null"> description = #{description},</if>
            <if test="status != null">status = #{status},</if>
            updated_date = NOW()
        WHERE checklist_idx = #{checklistIdx}
    </update>

    <delete id="deleteChecklist" parameterType="long">
        DELETE FROM checklist
        WHERE checklist_idx = #{checklistIdx}
    </delete>

    <insert id="insertChecklistItem" parameterType="com.project.messanger.dto.ChecklistItemDto">
        INSERT INTO checklist_item
        (
            checklist_idx,
            title,
            description,
            updated_date
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
        (
            #{item.checkListIdx},
            #{item.title},
            #{item.description},
            NOW()
        )
        </foreach>
    </insert>

    <update id="updateChecklistItem" parameterType="com.project.messanger.dto.ChecklistItemDto">
        UPDATE checklist_item
        SET <if test="title != null"> title= #{title},</if>
            <if test="description != null"> description = #{description},</if>
            updated_date = NOW()
        WHERE item_idx = #{itemIdx}
    </update>
</mapper>